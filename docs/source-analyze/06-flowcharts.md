# Code-Graph-RAG 工作流程详解 - 第六部分：完整流程图

## 1. 整体流程图

```mermaid
graph TD
    A["cgr start --repo-path --update-graph --clean"] --> B["CLI 解析参数"]
    B --> C["加载配置和 .cgrignore"]
    C --> D["连接 Memgraph 数据库"]
    D --> E{"clean 标志?"}
    E -->|是| F["清理数据库"]
    E -->|否| G["确保约束"]
    F --> G
    G --> H["加载解析器 load_parsers"]
    H --> I["创建 GraphUpdater"]
    I --> J["执行 updater.run"]

    J --> K["阶段1: 识别结构"]
    K --> L["阶段2: 处理文件"]
    L --> M["阶段3: 处理调用"]
    M --> N["阶段4: 方法重写"]
    N --> O["阶段5: 刷新数据库"]
    O --> P["阶段6: 生成嵌入"]
    P --> Q["完成"]
```

## 2. 文件处理详细流程

```mermaid
graph TD
    A["遍历仓库文件"] --> B{"是源代码文件?"}
    B -->|是| C["获取语言配置"]
    B -->|否| D{"是依赖文件?"}
    D -->|是| E["处理依赖文件"]
    D -->|否| F["处理通用文件"]

    C --> G["读取文件字节"]
    G --> H["tree-sitter 解析 AST"]
    H --> I["构建模块限定名"]
    I --> J["创建模块节点"]
    J --> K["创建模块关系"]
    K --> L["解析导入"]
    L --> M["提取类和函数"]
    M --> N["注册到 function_registry"]
    N --> O["缓存 AST"]

    E --> P["解析依赖信息"]
    P --> Q["创建外部包节点"]
    Q --> R["创建依赖关系"]

    F --> S["创建文件节点"]
    S --> T["创建文件关系"]
```

## 3. Java 类解析流程

```mermaid
graph TD
    A["查询类节点"] --> B["遍历每个类节点"]
    B --> C["提取类信息"]
    C --> D["构建类限定名"]
    D --> E["判断节点类型"]
    E --> F{"类类型"}
    F -->|class| G["Class 节点"]
    F -->|interface| H["Interface 节点"]
    F -->|enum| I["Enum 节点"]
    F -->|annotation| J["Annotation 节点"]
    F -->|record| K["Record 节点"]

    G --> L["提取父类"]
    H --> M["提取父接口"]
    I --> N["提取枚举值"]
    J --> O["提取注解元素"]
    K --> P["提取记录组件"]

    L --> Q["创建类节点"]
    M --> Q
    N --> Q
    O --> Q
    P --> Q

    Q --> R["创建 DEFINES 关系"]
    R --> S["创建继承关系"]
    S --> T["创建实现关系"]
    T --> U["提取类方法"]
    U --> V["处理每个方法"]
```

## 4. Java 方法解析流程

```mermaid
graph TD
    A["查询方法节点"] --> B["遍历每个方法节点"]
    B --> C["提取方法信息"]
    C --> D{"方法类型"}
    D -->|method| E["提取方法名"]
    D -->|constructor| F["提取构造函数名"]

    E --> G["提取返回类型"]
    F --> H["构造函数无返回类型"]
    G --> I["提取参数类型"]
    H --> I
    I --> J["提取修饰符"]
    J --> K["提取注解"]
    K --> L["构建方法限定名"]

    L --> M{"包含参数?"}
    M -->|是| N["方法名 + 参数签名"]
    M -->|否| O["仅方法名"]

    N --> P["创建方法节点"]
    O --> P
    P --> Q["注册到 function_registry"]
    Q --> R["创建 DEFINES_METHOD 关系"]
```

## 5. 方法调用解析流程

```mermaid
graph TD
    A["查询调用节点"] --> B["遍历每个调用节点"]
    B --> C["提取调用目标名"]
    C --> D{"调用类型"}
    D -->|"Java 方法调用"| E["解析 Java 方法调用"]
    D -->|"普通函数调用"| F["解析函数调用"]
    D -->|"内置函数"| G["解析内置函数"]
    D -->|"C++ 操作符"| H["解析操作符调用"]

    E --> I["推断调用对象类型"]
    I --> J["提取方法名和参数"]
    J --> K["在 function_registry 查找"]
    K --> L{"找到匹配?"}
    L -->|是| M["获取方法限定名"]
    L -->|否| N["查找父类方法"]
    N --> O{"找到?"}
    O -->|是| M
    O -->|否| P["跳过"]

    F --> Q["解析函数名"]
    Q --> R["查找函数定义"]
    R --> S{"找到?"}
    S -->|是| M
    S -->|否| P

    G --> T["创建内置函数节点"]
    H --> U["查找操作符重载"]

    M --> V["创建 CALLS 关系"]
    T --> V
    U --> V
```

## 6. 数据库插入流程

```mermaid
graph TD
    A["ensure_node_batch"] --> B["添加到 node_buffer"]
    B --> C{"缓冲区满?"}
    C -->|是| D["flush_nodes"]
    C -->|否| E["继续"]

    D --> F["按标签分组"]
    F --> G["遍历每个标签"]
    G --> H["获取唯一约束键"]
    H --> I["构建批量数据"]
    I --> J["构建 MERGE 查询"]
    J --> K["执行 UNWIND 批量插入"]
    K --> L["清空缓冲区"]

    M["ensure_relationship_batch"] --> N["添加到 relationship_buffer"]
    N --> O{"缓冲区满?"}
    O -->|是| P["flush_relationships"]
    O -->|否| Q["继续"]

    P --> R["先刷新节点"]
    R --> S["按模式分组"]
    S --> T["遍历每个模式"]
    T --> U["构建 MATCH-MERGE 查询"]
    U --> V["执行批量插入"]
    V --> W["统计成功数"]
    W --> X["清空缓冲区"]
```

## 7. 类型推断流程

```mermaid
graph TD
    A["分析函数/方法节点"] --> B["查找局部变量声明"]
    B --> C["提取变量名和类型"]
    C --> D{"类型已知?"}
    D -->|是| E["添加到类型映射"]
    D -->|否| F["推断类型"]

    F --> G{"推断方式"}
    G -->|"初始化表达式"| H["分析初始化类型"]
    G -->|"方法调用返回"| I["分析返回类型"]
    G -->|"参数类型"| J["使用参数类型"]
    G -->|"字段访问"| K["分析字段类型"]

    H --> E
    I --> E
    J --> E
    K --> E

    E --> L["构建类型映射表"]
    L --> M["用于调用解析"]
```

## 8. 查询流程

```mermaid
graph TD
    A["用户自然语言问题"] --> B["RAG Orchestrator"]
    B --> C{"查询类型判断"}
    C -->|"结构化查询"| D["CypherGenerator"]
    C -->|"语义查询"| E["SemanticSearch"]

    D --> F["LLM 生成 Cypher"]
    F --> G["执行 Cypher 查询"]
    G --> H["返回结果"]

    E --> I["生成查询嵌入"]
    I --> J["向量数据库搜索"]
    J --> K["获取节点 ID"]
    K --> L["查询节点详情"]
    L --> H

    H --> M{"需要源代码?"}
    M -->|是| N["CodeRetriever"]
    M -->|否| O["生成回答"]

    N --> P["提取源代码"]
    P --> O
```

## 9. 导入解析流程

```mermaid
graph TD
    A["查询导入节点"] --> B{"语言类型"}
    B -->|Java| C["解析 Java 导入"]
    B -->|Python| D["解析 Python 导入"]
    B -->|"JavaScript/TypeScript"| E["解析 JS/TS 导入"]
    B -->|Rust| F["解析 Rust 导入"]
    B -->|Go| G["解析 Go 导入"]
    B -->|"C++"| H["解析 C++ 导入"]

    C --> I["提取导入路径"]
    I --> J{"静态导入?"}
    J -->|是| K["标记静态"]
    J -->|否| L["普通导入"]

    K --> M["解析路径"]
    L --> M
    M --> N{"通配符?"}
    N -->|是| O["存储通配符映射"]
    N -->|否| P["存储名称映射"]

    O --> Q["创建 IMPORTS 关系"]
    P --> Q

    D --> R["处理 import/from"]
    E --> S["处理 ES6/CommonJS"]
    F --> T["处理 use"]
    G --> U["处理 import"]
    H --> V["处理 include/import"]
```

## 10. 方法重写检测流程

```mermaid
graph TD
    A["遍历所有类"] --> B["获取类的所有祖先"]
    B --> C["遍历祖先类"]
    C --> D["查找祖先类的方法"]
    D --> E["遍历子类方法"]
    E --> F{"方法名相同?"}
    F -->|否| E
    F -->|是| G{"参数签名相同?"}
    G -->|否| E
    G -->|是| H["创建 OVERRIDES 关系"]
    H --> I{"还有方法?"}
    I -->|是| E
    I -->|否| J{"还有祖先?"}
    J -->|是| C
    J -->|否| K{"还有类?"}
    K -->|是| A
    K -->|否| L["完成"]
```

## 11. 嵌入生成流程

```mermaid
graph TD
    A["查询所有函数/方法"] --> B["遍历每个节点"]
    B --> C["获取节点信息"]
    C --> D["提取源代码位置"]
    D --> E{"AST 缓存存在?"}
    E -->|是| F["使用 AST 精确提取"]
    E -->|否| G["使用行号范围提取"]

    F --> H["获取源代码"]
    G --> H
    H --> I["生成嵌入向量"]
    I --> J["存储到向量数据库"]
    J --> K["关联节点 ID"]
    K --> L{"还有节点?"}
    L -->|是| B
    L -->|否| M["完成"]
```

## 12. 完整数据流图

```mermaid
graph LR
    A["Java 源文件"] --> B["tree-sitter 解析"]
    B --> C["AST"]
    C --> D["提取模块"]
    C --> E["提取导入"]
    C --> F["提取类"]
    C --> G["提取方法"]
    C --> H["提取调用"]

    D --> I["模块节点"]
    E --> J["导入关系"]
    F --> K["类节点"]
    G --> L["方法节点"]
    H --> M["调用关系"]

    K --> N["继承关系"]
    K --> O["实现关系"]
    L --> P["DEFINES_METHOD 关系"]

    I --> Q["Memgraph 数据库"]
    J --> Q
    K --> Q
    L --> Q
    M --> Q
    N --> Q
    O --> Q
    P --> Q

    Q --> R["Cypher 查询"]
    Q --> S["语义搜索"]

    R --> T["结构化结果"]
    S --> U["语义结果"]

    T --> V["RAG 回答"]
    U --> V
```

## 13. 相关文档

- [第一部分：总览和入口流程](./01-overview-and-entry.md)
- [第二部分：Java 语法解析详细流程](./02-java-parsing.md)
- [第三部分：数据库插入逻辑](./03-database-insertion.md)
- [第四部分：查询逻辑](./04-query-logic.md)
- [第五部分：关键数据结构](./05-data-structures.md)
